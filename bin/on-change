#!/usr/bin/env python3
from __future__ import print_function

import signal
import argparse
import fcntl
import os
import sys
import errno
from time import sleep, time
from subprocess import Popen, PIPE, TimeoutExpired


current_process = None

def oneshot(args, events):
    global current_process

    current_process = Popen(args)
    current_process.wait()
    for r in events:
        current_process = Popen(args)
        current_process.wait()


def longpoll(args, events):
    global current_process
    start = time()
    current_process = Popen(args)
    for r in events:
        if start + 1 < r:
            current_process.terminate()
            current_process.wait()
            start = time()
            current_process = Popen(args)


def get_events(watch_list, timeout=0.3):
    wp = Popen(['inotifywait', '-m', '-r', '-e', 'create', '-e', 'modify'] + watch_list, stdout=PIPE)
    fcntl.fcntl(wp.stdout, fcntl.F_SETFL, os.O_NONBLOCK)

    def shutdown(signal, frame):
        if current_process:
            current_process.terminate()
            try:
                current_process.wait(2)
            except TimeoutExpired:
                current_process.kill()
                current_process.wait()
        sys.exit(0)

    signal.signal(signal.SIGINT, shutdown)
    signal.signal(signal.SIGTERM, shutdown)

    def read():
        try:
            return wp.stdout.read()
        except IOError as e:
            if e.errno == errno.EAGAIN:
                return
            else:
                raise

    start = None
    while True:
        data = read()

        if data:
            start = time()
            continue

        if start and time() - start > timeout:
            start = None
            yield time()
            read()

        sleep(0.3)


if __name__ == '__main__':
    parser = argparse.ArgumentParser()
    parser.add_argument('-w', dest='watch', action='append')
    parser.add_argument('-d', dest='daemon', action='store_true')
    args, rest = parser.parse_known_args()

    if not rest:
        print('You should provide a command to execute on change', file=sys.stderr)
        sys.exit(1)

    if rest[0] == '--':
        rest = rest[1:]

    watch_list = args.watch or ['.']
    try:
        if args.daemon:
            longpoll(rest, get_events(watch_list))
        else:
            oneshot(rest, get_events(watch_list))
    except KeyboardInterrupt:
        pass
